{% extends "base.html" %}
{% block title %}çˆ¬èŸ²æ§åˆ¶{% endblock %}

{% block content %}
<div class="row g-3 align-items-center mb-3">
  <div class="col">
    <h4 class="mb-0">çˆ¬èŸ²æ§åˆ¶</h4>
    <div class="text-muted small">é¸æ“‡ä¾†æºï¼ˆé–‹/é—œï¼‰â†’ å³æ™‚æ›´æ–°æˆ–å•Ÿå‹•å®šæœŸæ›´æ–°</div>
  </div>
</div>

<div class="row g-3">
  <!-- HN -->
  <div class="col-12 col-md-6 col-xl-4">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body d-flex flex-column">
        <div class="display-6 mb-2">ğŸ”µ</div>
        <h6 class="card-title">Hacker News</h6>
        <p class="text-muted small">ä¾†æºç‹€æ…‹ï¼š
          <strong class="{{ 'text-success' if (sources and sources.get('hn')) else 'text-secondary' }}">
            {{ 'å·²é–‹å•Ÿ' if (sources and sources.get('hn')) else 'å·²é—œé–‰' }}
          </strong>
        </p>
        <form action="{{ url_for('toggle_source', src='hn') }}" method="post" class="mt-auto">
          <button class="btn {{ 'btn-outline-danger' if (sources and sources.get('hn')) else 'btn-primary' }} w-100">
            {{ 'é—œé–‰' if (sources and sources.get('hn')) else 'é–‹å•Ÿ' }}
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Reddit -->
  <div class="col-12 col-md-6 col-xl-4">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body d-flex flex-column">
        <div class="display-6 mb-2">ğŸŸ¢</div>
        <h6 class="card-title">Reddit</h6>
        <p class="text-muted small">ä¾†æºç‹€æ…‹ï¼š
          <strong class="{{ 'text-success' if (sources and sources.get('reddit')) else 'text-secondary' }}">
            {{ 'å·²é–‹å•Ÿ' if (sources and sources.get('reddit')) else 'å·²é—œé–‰' }}
          </strong>
        </p>
        <form action="{{ url_for('toggle_source', src='reddit') }}" method="post" class="mt-auto">
          <button class="btn {{ 'btn-outline-danger' if (sources and sources.get('reddit')) else 'btn-success' }} w-100">
            {{ 'é—œé–‰' if (sources and sources.get('reddit')) else 'é–‹å•Ÿ' }}
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- StackEx -->
  <div class="col-12 col-md-6 col-xl-4">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body d-flex flex-column">
        <div class="display-6 mb-2">ğŸŸ£</div>
        <h6 class="card-title">Security StackExchange</h6>
        <p class="text-muted small">ä¾†æºç‹€æ…‹ï¼š
          <strong class="{{ 'text-success' if (sources and sources.get('stackex')) else 'text-secondary' }}">
            {{ 'å·²é–‹å•Ÿ' if (sources and sources.get('stackex')) else 'å·²é—œé–‰' }}
          </strong>
        </p>
        <form action="{{ url_for('toggle_source', src='stackex') }}" method="post" class="mt-auto">
          <button class="btn {{ 'btn-outline-primary' if (sources and sources.get('stackex')) else 'btn-primary' }} w-100">
            {{ 'é—œé–‰' if (sources and sources.get('stackex')) else 'é–‹å•Ÿ' }}
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- å³æ™‚æ›´æ–° -->
  <div class="col-12 col-md-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body d-flex flex-column">
        <div class="display-6 mb-2">â±ï¸</div>
        <h6 class="card-title">å³æ™‚æ›´æ–°</h6>
        <p class="text-muted small">åªæœƒåŸ·è¡Œ<strong>å·²é–‹å•Ÿ</strong>çš„ä¾†æºï¼Œä¸¦æ–¼èƒŒæ™¯é€²è¡Œã€‚</p>
        <button id="btn-refresh" class="btn btn-outline-secondary w-100" type="button">åŸ·è¡Œä¸€æ¬¡</button>

        <!-- é€²åº¦é¡¯ç¤ºå€ -->
        <div class="small text-muted mt-2" id="refresh-msg">å°šæœªåŸ·è¡Œ</div>
        <div id="refresh_status_box" class="mt-2 p-2 rounded border small" style="background:#f8fafc;">
          ï¼ˆç­‰å¾…ä¸­ï¼‰
        </div>
      </div>
    </div>
  </div>

  <!-- å®šæœŸæ›´æ–° -->
  <div class="col-12 col-md-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="display-6 mb-2">ğŸ“…</div>
            <h6 class="card-title d-inline">å®šæœŸæ›´æ–°</h6>
          </div>
          {% if schedule %}
            <span class="badge bg-success">é‹è¡Œä¸­</span>
          {% else %}
            <span class="badge bg-secondary">æœªå•Ÿå‹•</span>
          {% endif %}
        </div>

        <p class="text-muted small mb-2">
          ç›®å‰é–“éš”ï¼š<strong>{{ schedule.minutes if schedule else '-' }} åˆ†é˜</strong>ï¼›
          ä¸‹æ¬¡åŸ·è¡Œï¼š
          <strong id="next-run-time" class="font-monospace">{{ schedule.next if schedule else '-' }}</strong>
          <span id="next-run-countdown" class="ms-2 text-muted small"></span>
        </p>

        <form action="{{ url_for('start_schedule') }}" method="post" class="row g-2">
          <div class="col-12">
            <label class="form-label small">é è¨­é–“éš”</label>
            <select name="preset" class="form-select">
              <option value="30m">30 åˆ†é˜</option>
              <option value="1h">1 å°æ™‚</option>
              <option value="2h">2 å°æ™‚</option>
              <option value="3h">3 å°æ™‚</option>
              <option value="5h">5 å°æ™‚</option>
              <option value="10h">10 å°æ™‚</option>
              <option value="custom">è‡ªè¨‚</option>
            </select>
          </div>
          <div class="col-6">
            <label class="form-label small">è‡ªè¨‚æ•¸å€¼</label>
            <input type="number" min="1" class="form-control" name="custom_value" placeholder="æ•¸å­—">
          </div>
          <div class="col-6">
            <label class="form-label small">å–®ä½</label>
            <select name="custom_unit" class="form-select">
              <option value="minutes">åˆ†é˜</option>
              <option value="hours">å°æ™‚</option>
            </select>
          </div>
          <div class="col-12 d-grid">
            <button class="btn btn-primary">å•Ÿå‹•å®šæœŸæ›´æ–°</button>
          </div>
        </form>

        <form action="{{ url_for('stop_schedule') }}" method="post" class="mt-2 d-grid">
          <button class="btn btn-outline-danger">åœæ­¢å®šæœŸæ›´æ–°</button>
        </form>
      </div>
    </div>
  </div>
</div>

{% raw %}
<script>
(function(){
  // ---- å³æ™‚æ›´æ–°å€å¡Šï¼šä¿ç•™ä½ åŸæœ¬çš„è¼ªè©¢ ----
  const btn = document.getElementById('btn-refresh');
  const msg = document.getElementById('refresh-msg');
  const box = document.getElementById('refresh_status_box');
  let pollTimer = null;

  function renderStatus(d){
    const c = d.counts || {};
    const phase = d.phase || 'idle';
    const lines = (d.log_tail || []).join('\n');
    box.innerHTML = `
      <div>ç‹€æ…‹ï¼š<b>${d.status}</b>ï¼ˆéšæ®µï¼š${phase}ï¼‰</div>
      <div>ä¾†æºï¼š${(d.sources||[]).join(', ') || '-'}</div>
      <div>è²¼æ–‡ï¼štotal=${c.posts_total ?? '-'} / +${c.posts_added ?? 0}</div>
      <div>ç•™è¨€ï¼štotal=${c.comments_total ?? '-'} / +${c.comments_added ?? 0}</div>
      <div>åˆ†é¡ï¼šprocessed=${c.labeled_processed ?? 0} / å¯«å…¥è¨“ç·´ +${c.labeled_inserted ?? 0}</div>
      <pre style="max-height:150px;overflow:auto;margin-top:6px;background:#fff;padding:8px;border-radius:8px;border:1px dashed #e5e7eb;">${lines}</pre>
    `;
  }

  async function pollRefresh(){
    try{
      const r = await fetch('/api/refresh_status');
      const d = await r.json();
      renderStatus(d);
      if (d.status === 'running'){
        pollTimer = setTimeout(pollRefresh, 1500);
      } else if (pollTimer){
        clearTimeout(pollTimer);
      }
    }catch(e){
      msg.textContent = 'âŒ è®€å–é€²åº¦å¤±æ•—ï¼š' + e;
      pollTimer = setTimeout(pollRefresh, 2000);
    }
  }

  async function triggerRefresh(){
    try{
      btn.disabled = true;
      btn.innerText = 'åŸ·è¡Œä¸­â€¦';
      msg.textContent = 'å·²é€å‡ºè«‹æ±‚ï¼ŒèƒŒæ™¯åŸ·è¡Œä¸­â€¦ï¼ˆåªæœƒè·‘å·²é–‹å•Ÿä¾†æºï¼‰';
      box.innerHTML = 'èƒŒæ™¯åŸ·è¡Œä¸­â€¦';
      await fetch('/api/refresh_now', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({})
      });
      pollRefresh();
    }catch(e){
      msg.textContent = 'âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š' + e;
    }finally{
      setTimeout(()=>{ btn.innerText = 'åŸ·è¡Œä¸€æ¬¡'; btn.disabled = false; }, 1200);
    }
  }

  if (btn) btn.addEventListener('click', triggerRefresh);
  document.addEventListener('DOMContentLoaded', pollRefresh);

  // ---- å®šæœŸæ›´æ–°ï¼šå€’æ•¸è¨ˆæ™‚ï¼ˆèˆ‡ actions.js ç‰ˆç›¸å®¹ï¼‰ ----
  (function bindScheduleCountdown(){
    const timeEl = document.getElementById('next-run-time');
    const cdEl   = document.getElementById('next-run-countdown');
    if (!timeEl || !cdEl) return;

    let timer = null;
    const pad = n => String(n).padStart(2, "0");
    const fmtLeft = (ms) => {
      let s = Math.max(0, Math.floor(ms / 1000));
      const h = Math.floor(s / 3600); s %= 3600;
      const m = Math.floor(s / 60);   s %= 60;
      return h > 0 ? `${h}:${pad(m)}:${pad(s)}` : `${m}:${pad(s)}`;
    };

    async function loadAndStart(){
      try{
        const r = await fetch('/api/schedule_info', { credentials: 'same-origin' });
        const j = await r.json();
        if (!j.ok || !j.enabled || !j.next_epoch){
          cdEl.textContent = 'â€”';
          if (j.next_iso) timeEl.textContent = j.next_iso;
          if (timer) { clearInterval(timer); timer = null; }
          return;
        }
        const nextEpoch = j.next_epoch;
        if (j.next_iso) timeEl.textContent = j.next_iso;

        function tick(){
          const left = nextEpoch - Date.now();
          if (left <= 0){
            cdEl.textContent = 'å³å°‡åŸ·è¡Œâ€¦';
            clearInterval(timer);
            timer = setTimeout(loadAndStart, 3000);
            return;
          }
          cdEl.textContent = `å€’æ•¸ ${fmtLeft(left)}`;
          cdEl.title = `ä¸‹æ¬¡åŸ·è¡Œï¼š${j.next_iso || ''}`;
        }

        if (timer) clearInterval(timer);
        tick();
        timer = setInterval(tick, 1000);
      }catch(e){
        console.warn(e);
        cdEl.textContent = 'ï¼ˆè®€å–å¤±æ•—ï¼‰';
        if (timer) { clearInterval(timer); timer = null; }
      }
    }

    document.addEventListener('DOMContentLoaded', loadAndStart);
  })();
})();
</script>
{% endraw %}
{% endblock %}
