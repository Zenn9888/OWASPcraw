{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="row g-3 align-items-center mb-3">
  <div class="col">
    <h4 class="mb-0">Dashboard</h4>
    <div class="text-muted small">æœ€è¿‘ä¸€æ¬¡æ›´æ–°çš„åœ–è¡¨ Â· ä¸Šæ¬¡æ›´æ–°æ™‚é–“ Â· æ’ç¨‹ç‹€æ…‹</div>
  </div>
  <div class="col-auto d-flex gap-2">
    <form action="{{ url_for('refresh_now') }}" method="post">
      <button class="btn btn-outline-secondary">â±ï¸ ç«‹å³æ›´æ–°</button>
    </form>
    <a href="{{ url_for('manage_analysis') }}" class="btn btn-primary">ğŸ“‘ è³‡æ–™åˆ†æ</a>
  </div>
</div>

<!-- ç”¨ data-* æ”¾æ¨¡æ¿å€¼ï¼Œé¿å… script ä¸­å‡ºç¾ Jinja æ¨™è¨˜ -->
<div id="dashboard-data"
     data-chart-id="{{ latest_chart.id if latest_chart else '' }}"
     data-last-crawl="{{ last_crawl_at or '' }}">
</div>

<div class="row g-3">
  <!-- æœ€è¿‘ä¸€æ¬¡åœ–è¡¨ -->
  <div class="col-12 col-xl-8">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">æœ€è¿‘ä¸€æ¬¡æ›´æ–°çš„åœ–è¡¨</h6>
          {% if latest_chart %}
          <span class="text-muted small">ç”¢ç”Ÿæ–¼ï¼š{{ latest_chart.created_at }}</span>
          {% endif %}
        </div>

        {% if latest_chart %}
          <div id="echarts-latest" style="width:100%;height:420px;"></div>
        {% else %}
          <div class="text-muted small">
            å°šæœªç”¢ç”Ÿåœ–è¡¨ã€‚å‰å¾€ <a href="{{ url_for('manage_analysis') }}">è³‡æ–™åˆ†æ</a> ç”¢ç”Ÿã€ŒOWASP Top åˆ†ä½ˆã€åœ–è¡¨ã€‚
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- æ›´æ–°ç‹€æ…‹ -->
  <div class="col-12 col-xl-4">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <h6 class="mb-3">æ›´æ–°ç‹€æ…‹</h6>

        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="text-muted">ä¸Šæ¬¡è³‡æ–™æ›´æ–°æ™‚é–“</span>
          <strong id="last-update-time">{{ last_crawl_at if last_crawl_at else 'å°šæœªåŸ·è¡Œ' }}</strong>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="text-muted">è·é›¢ä¸Šæ¬¡æ›´æ–°</span>
          <strong id="time-since">â€”</strong>
        </div>

        <hr>

        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="text-muted">æ’ç¨‹ç‹€æ…‹</span>
          {% if schedule %}
            <span class="badge bg-success">é‹è¡Œä¸­</span>
          {% else %}
            <span class="badge bg-secondary">æœªå•Ÿå‹•</span>
          {% endif %}
        </div>

        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="text-muted">æ’ç¨‹é–“éš”</span>
          <strong>{{ schedule.minutes if schedule else '-' }} åˆ†é˜</strong>
        </div>

        <div class="d-flex justify-content-between align-items-center">
          <span class="text-muted">ä¸‹æ¬¡åŸ·è¡Œ</span>
          <div class="d-flex align-items-center gap-2">
            <strong id="next-run-time" class="font-monospace">{{ schedule.next if schedule else '-' }}</strong>
            <span id="next-run-countdown" class="text-muted small"></span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% if latest_chart %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
{% endif %}

{% raw %}
<script>
(function(){
  const dataEl = document.getElementById('dashboard-data');
  const chartId = dataEl ? (dataEl.dataset.chartId || '') : '';
  const lastStr = dataEl ? (dataEl.dataset.lastCrawl || '') : '';

  function loadLatestChart(){
    if (!chartId) return;
    if (typeof echarts === 'undefined') return;
    const dom = document.getElementById('echarts-latest');
    if (!dom) return;

    fetch(`/api/chart/${encodeURIComponent(chartId)}`)
      .then(r => r.json())
      .then(cfg => {
        const ins = echarts.init(dom);
        ins.setOption((cfg && cfg.option) || {}, true);
        window.addEventListener('resize', () => ins.resize());
      })
      .catch(err => console.warn('load latest chart failed', err));
  }

  function startTimeSince(){
    const el = document.getElementById('time-since');
    if (!el) return;
    if (!lastStr){ el.textContent = 'â€”'; return; }
    const base = new Date(lastStr.replace(' ', 'T'));
    function fmt(ms){
      const s = Math.floor(ms/1000);
      const d = Math.floor(s/86400);
      const h = Math.floor((s%86400)/3600);
      const m = Math.floor((s%3600)/60);
      const ss = s%60;
      if (d>0) return `${d}å¤© ${h}å°æ™‚ ${m}åˆ†`;
      if (h>0) return `${h}å°æ™‚ ${m}åˆ† ${ss}ç§’`;
      if (m>0) return `${m}åˆ† ${ss}ç§’`;
      return `${ss}ç§’`;
    }
    function tick(){
      const diff = Date.now() - base.getTime();
      if (diff < 0) { el.textContent = 'â€”'; return; }
      el.textContent = fmt(diff);
    }
    tick();
    setInterval(tick, 1000);
  }

  // ---- å€’æ•¸è¨ˆæ™‚ï¼ˆèˆ‡ actions.js ç‰ˆç›¸å®¹ï¼‰ ----
  (function bindScheduleCountdown(){
    const timeEl = document.getElementById('next-run-time');
    const cdEl   = document.getElementById('next-run-countdown');
    if (!timeEl || !cdEl) return;

    let timer = null;
    const pad = n => String(n).padStart(2, "0");
    const fmtLeft = (ms) => {
      let s = Math.max(0, Math.floor(ms / 1000));
      const h = Math.floor(s / 3600); s %= 3600;
      const m = Math.floor(s / 60);   s %= 60;
      return h > 0 ? `${h}:${pad(m)}:${pad(s)}` : `${m}:${pad(s)}`;
    };

    async function loadAndStart(){
      try{
        const r = await fetch('/api/schedule_info', { credentials: 'same-origin' });
        const j = await r.json();
        if (!j.ok || !j.enabled || !j.next_epoch){
          cdEl.textContent = 'â€”';
          if (j.next_iso) timeEl.textContent = j.next_iso;
          if (timer) { clearInterval(timer); timer = null; }
          return;
        }
        const nextEpoch = j.next_epoch;
        if (j.next_iso) timeEl.textContent = j.next_iso;

        function tick(){
          const left = nextEpoch - Date.now();
          if (left <= 0){
            cdEl.textContent = 'å³å°‡åŸ·è¡Œâ€¦';
            clearInterval(timer);
            timer = setTimeout(loadAndStart, 3000);
            return;
          }
          cdEl.textContent = `å€’æ•¸ ${fmtLeft(left)}`;
          cdEl.title = `ä¸‹æ¬¡åŸ·è¡Œï¼š${j.next_iso || ''}`;
        }

        if (timer) clearInterval(timer);
        tick();
        timer = setInterval(tick, 1000);
      }catch(e){
        console.warn(e);
        cdEl.textContent = 'ï¼ˆè®€å–å¤±æ•—ï¼‰';
        if (timer) { clearInterval(timer); timer = null; }
      }
    }

    loadAndStart();
  })();

  document.addEventListener('DOMContentLoaded', function(){
    loadLatestChart();
    startTimeSince();
  });
})();
</script>
{% endraw %}
{% endblock %}
